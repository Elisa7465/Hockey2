
#pragma once
#include "Header.h"

namespace Hockey2 {

    using namespace System;
    using namespace System::Windows::Forms;
    using namespace System::Drawing;
    public ref class MyForm : public System::Windows::Forms::Form
    {
    public:
        MyForm()
        {
            InitializeComponent();
            InitializeGame();
        }

    protected:
        ~MyForm()
        {
            if (components)
            {
                delete components;
            }
        }
    private: System::ComponentModel::IContainer^ components;
    protected:
    private:System::Windows::Forms::Button^ buttonAddBluePlayer;
    private: System::Windows::Forms::PictureBox^ pictureBox1;// PictureBox äëÿ îòîáğàæåíèÿ èãğîâîãî ïîëÿ
    private: System::Windows::Forms::Button^ Addredplayer;
    private: System::Windows::Forms::MenuStrip^ menuStrip1;
    private: System::Windows::Forms::ToolStripMenuItem^ ôàéëToolStripMenuItem;
    private: System::Windows::Forms::ToolStripMenuItem^ ñîõğàíèòüToolStripMenuItem;
    private: System::Windows::Forms::ToolStripMenuItem^ çàãğToolStripMenuItem;
    private: System::Windows::Forms::OpenFileDialog^ openFileDialog1;
    private: System::Windows::Forms::Button^ button1;
    private: System::Windows::Forms::SaveFileDialog^ saveFileDialog1;
    private: System::Windows::Forms::Button^ button2;
    private: System::Windows::Forms::Button^ button3;
           Arrow^ newArrow;
           List<Arrow^>^ arrows;
    private: System::Windows::Forms::Button^ button4;
         // Îáúåêò êàòêà
    private: IceRink^ iceRink;
           // Èíèöèàëèçàöèÿ èãğîâûõ ıëåìåíòîâ
           void InitializeGame()
           {
               newArrow = gcnew Arrow();
               // Ñîçäàíèå îáúåêòà êàòêà
               iceRink = gcnew IceRink(pictureBox1);

               iceRink->Draw();
           }
           // Îáğàáîò÷èê ñîáûòèÿ êëèêà íà "Ìîÿ ñòğåëêà"
#pragma region Windows Form Designer generated code
           void InitializeComponent(void)
           {
               this->pictureBox1 = (gcnew System::Windows::Forms::PictureBox());
               this->buttonAddBluePlayer = (gcnew System::Windows::Forms::Button());
               this->Addredplayer = (gcnew System::Windows::Forms::Button());
               this->menuStrip1 = (gcnew System::Windows::Forms::MenuStrip());
               this->ôàéëToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
               this->ñîõğàíèòüToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
               this->çàãğToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
               this->openFileDialog1 = (gcnew System::Windows::Forms::OpenFileDialog());
               this->button1 = (gcnew System::Windows::Forms::Button());
               this->saveFileDialog1 = (gcnew System::Windows::Forms::SaveFileDialog());
               this->button2 = (gcnew System::Windows::Forms::Button());
               this->button3 = (gcnew System::Windows::Forms::Button());
               this->button4 = (gcnew System::Windows::Forms::Button());
               (cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox1))->BeginInit();
               this->menuStrip1->SuspendLayout();
               this->SuspendLayout();
               // 
               // pictureBox1
               // 
               this->pictureBox1->BackColor = System::Drawing::Color::White;
               this->pictureBox1->Location = System::Drawing::Point(12, 27);
               this->pictureBox1->Name = L"pictureBox1";
               this->pictureBox1->Size = System::Drawing::Size(1200, 558);
               this->pictureBox1->TabIndex = 0;
               this->pictureBox1->TabStop = false;
               this->pictureBox1->DoubleClick += gcnew System::EventHandler(this, &MyForm::pictureBox1_DoubleClick);
               this->pictureBox1->MouseDown += gcnew System::Windows::Forms::MouseEventHandler(this, &MyForm::pictureBox1_MouseDown);
               this->pictureBox1->MouseMove += gcnew System::Windows::Forms::MouseEventHandler(this, &MyForm::pictureBox1_MouseMove);
               this->pictureBox1->MouseUp += gcnew System::Windows::Forms::MouseEventHandler(this, &MyForm::pictureBox1_MouseUp);
               // 
               // buttonAddBluePlayer
               // 
               this->buttonAddBluePlayer->BackColor = System::Drawing::Color::SkyBlue;
               this->buttonAddBluePlayer->Location = System::Drawing::Point(1228, 40);
               this->buttonAddBluePlayer->Name = L"buttonAddBluePlayer";
               this->buttonAddBluePlayer->Size = System::Drawing::Size(181, 76);
               this->buttonAddBluePlayer->TabIndex = 1;
               this->buttonAddBluePlayer->Text = L"Äîáàâèòü ñèíåãî õîêêåèñòà";
               this->buttonAddBluePlayer->UseVisualStyleBackColor = false;
               this->buttonAddBluePlayer->Click += gcnew System::EventHandler(this, &MyForm::buttonAddBluePlayer_Click);
               // 
               // Addredplayer
               // 
               this->Addredplayer->BackColor = System::Drawing::Color::Tomato;
               this->Addredplayer->Location = System::Drawing::Point(1228, 133);
               this->Addredplayer->Name = L"Addredplayer";
               this->Addredplayer->Size = System::Drawing::Size(181, 69);
               this->Addredplayer->TabIndex = 2;
               this->Addredplayer->Text = L"Äîáàâèòü êğàñíîãî õîêêåèñòà";
               this->Addredplayer->UseVisualStyleBackColor = false;
               this->Addredplayer->Click += gcnew System::EventHandler(this, &MyForm::buttonAddRedPlayer_Click);
               // 
               // menuStrip1
               // 
               this->menuStrip1->ImageScalingSize = System::Drawing::Size(20, 20);
               this->menuStrip1->Items->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(1) { this->ôàéëToolStripMenuItem });
               this->menuStrip1->Location = System::Drawing::Point(0, 0);
               this->menuStrip1->Name = L"menuStrip1";
               this->menuStrip1->Size = System::Drawing::Size(1421, 28);
               this->menuStrip1->TabIndex = 3;
               this->menuStrip1->Text = L"menuStrip1";
               // 
               // ôàéëToolStripMenuItem
               // 
               this->ôàéëToolStripMenuItem->DropDownItems->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(2) {
                   this->ñîõğàíèòüToolStripMenuItem,
                       this->çàãğToolStripMenuItem
               });
               this->ôàéëToolStripMenuItem->Name = L"ôàéëToolStripMenuItem";
               this->ôàéëToolStripMenuItem->Size = System::Drawing::Size(59, 24);
               this->ôàéëToolStripMenuItem->Text = L"Ôàéë";
               // 
               // ñîõğàíèòüToolStripMenuItem
               // 
               this->ñîõğàíèòüToolStripMenuItem->Name = L"ñîõğàíèòüToolStripMenuItem";
               this->ñîõğàíèòüToolStripMenuItem->Size = System::Drawing::Size(166, 26);
               this->ñîõğàíèòüToolStripMenuItem->Text = L"Ñîõğàíèòü";
               this->ñîõğàíèòüToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::SaveToXML_Click);
               // 
               // çàãğToolStripMenuItem
               // 
               this->çàãğToolStripMenuItem->Name = L"çàãğToolStripMenuItem";
               this->çàãğToolStripMenuItem->Size = System::Drawing::Size(166, 26);
               this->çàãğToolStripMenuItem->Text = L"Çàãğóçèòü";
               this->çàãğToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::LoadXML_Click);
               // 
               // openFileDialog1
               // 
               this->openFileDialog1->FileName = L"openFileDialog1";
               // 
               // button1
               // 
               this->button1->BackColor = System::Drawing::Color::LemonChiffon;
               this->button1->Location = System::Drawing::Point(1228, 220);
               this->button1->Name = L"button1";
               this->button1->Size = System::Drawing::Size(181, 65);
               this->button1->TabIndex = 4;
               this->button1->Text = L"Ñîõğàíèòü â xml";
               this->button1->UseVisualStyleBackColor = false;
               this->button1->Click += gcnew System::EventHandler(this, &MyForm::SaveToXML_Click);
               // 
               // button2
               // 
               this->button2->BackColor = System::Drawing::Color::LemonChiffon;
               this->button2->Location = System::Drawing::Point(1228, 302);
               this->button2->Name = L"button2";
               this->button2->Size = System::Drawing::Size(181, 65);
               this->button2->TabIndex = 5;
               this->button2->Text = L"Çàãğóçèòü èç xml";
               this->button2->UseVisualStyleBackColor = false;
               this->button2->Click += gcnew System::EventHandler(this, &MyForm::LoadXML_Click);
               // 
               // button3
               // 
               this->button3->Location = System::Drawing::Point(1228, 385);
               this->button3->Name = L"button3";
               this->button3->Size = System::Drawing::Size(181, 65);
               this->button3->TabIndex = 6;
               this->button3->Text = L"Äîáàâèòü ñòğåëêó";
               this->button3->UseVisualStyleBackColor = true;
               this->button3->Click += gcnew System::EventHandler(this, &MyForm::buttonDrawArrow_Click);
               // 
               // button4
               // 
               this->button4->Location = System::Drawing::Point(1228, 465);
               this->button4->Name = L"button4";
               this->button4->Size = System::Drawing::Size(181, 65);
               this->button4->TabIndex = 7;
               this->button4->Text = L"Óäàëèòü ñòğåëêó";
               this->button4->UseVisualStyleBackColor = true;
               this->button4->Click += gcnew System::EventHandler(this, &MyForm::delarrowToolStripMenuItem_Click);
               // 
               // MyForm
               // 
               this->BackColor = System::Drawing::SystemColors::InactiveCaption;
               this->ClientSize = System::Drawing::Size(1421, 641);
               this->Controls->Add(this->button4);
               this->Controls->Add(this->button3);
               this->Controls->Add(this->button2);
               this->Controls->Add(this->button1);
               this->Controls->Add(this->Addredplayer);
               this->Controls->Add(this->buttonAddBluePlayer);
               this->Controls->Add(this->pictureBox1);
               this->Controls->Add(this->menuStrip1);
               this->DoubleBuffered = true;
               this->MainMenuStrip = this->menuStrip1;
               this->Name = L"MyForm";
               this->Text = L"Hockey";
               (cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox1))->EndInit();
               this->menuStrip1->ResumeLayout(false);
               this->menuStrip1->PerformLayout();
               this->ResumeLayout(false);
               this->PerformLayout();

           }
#pragma endregion

           // Ïåğåìåííûå äëÿ îòñëåæèâàíèÿ ñîñòîÿíèÿ ïåğåòàñêèâàíèÿ
           bool isDragging;
           int draggedImageIndex;
           Point offset;
           bool start;

           // Îáğàáîò÷èê ñîáûòèÿ íàæàòèÿ êíîïêè ìûøè
           System::Void pictureBox1_MouseDown(System::Object^ sender, System::Windows::Forms::MouseEventArgs^ e) {
               isDragging = false;
               // Ïğîâåğêà, ïîïàäàåò ëè òî÷êà íàæàòèÿ â êàêîå-ëèáî èçîáğàæåíèå
               List<GraphicElement^>^ elements = iceRink->getgraphicElements();
               for (int i = 0; i < elements->Count; i++)
               {
                   Arrow^ arrow = dynamic_cast<Arrow^>(elements[i]);

                   if (elements[i]->merge != nullptr) {
                       System::Drawing::Rectangle imageRect = System::Drawing::Rectangle(Point(elements[i]->coordinates.X, elements[i]->coordinates.Y), elements[i]->merge->Size);
                       // Âàø êîä
                       if (imageRect.Contains(e->Location))
                       {
                           isDragging = true;
                           draggedImageIndex = i;
                           offset = Point(e->Location.X - elements[i]->coordinates.X, e->Location.Y - elements[i]->coordinates.Y);
                           break;
                       }
                   }
                   if (arrow != nullptr) {
                       System::Drawing::Rectangle imageRect = System::Drawing::Rectangle(arrow->arrowStart.X - 5, arrow->arrowStart.Y - 5, 10, 10);
                       if (imageRect.Contains(e->Location))
                       {
                           start = 1;
                           isDragging = true;
                           draggedImageIndex = i;
                           offset = Point(e->Location.X - arrow->arrowStart.X, e->Location.Y - arrow->arrowStart.Y);
                           break;
                       }
                       imageRect = System::Drawing::Rectangle(arrow->arrowEnd.X - 5, arrow->arrowEnd.Y - 5, 10, 10);
                       if (imageRect.Contains(e->Location))
                       {
                           start = 0;
                           isDragging = true;
                           draggedImageIndex = i;
                           offset = Point(e->Location.X - arrow->arrowEnd.X, e->Location.Y - arrow->arrowEnd.Y);
                           break;
                       }
                   }

               }
           }
           // Îáğàáîò÷èê ñîáûòèÿ ïåğåìåùåíèÿ ìûøè
           System::Void pictureBox1_MouseMove(System::Object^ sender, System::Windows::Forms::MouseEventArgs^ e) {
               if (isDragging) {
                   List<GraphicElement^>^ elements = iceRink->getgraphicElements();
                   if (draggedImageIndex >= 0 && draggedImageIndex < elements->Count) {
                       Arrow^ arrow = dynamic_cast<Arrow^>(elements[draggedImageIndex]);
                       if (arrow != nullptr) {
                           if (start) {
                               elements[draggedImageIndex]->arrowStart = Point(e->X - offset.X, e->Y - offset.Y);
                               iceRink->Draw();
                           }
                           else {
                               elements[draggedImageIndex]->arrowEnd = Point(e->X - offset.X, e->Y - offset.Y);
                               iceRink->Draw();
                           }
                       }
                       else {
                           elements[draggedImageIndex]->coordinates = Point(e->X - offset.X, e->Y - offset.Y);
                           iceRink->Draw();
                       }
                   }
               }
           }

           System::Void buttonAddBluePlayer_Click(System::Object^ sender, System::EventArgs^ e)
           {
               iceRink->AddBluePlayer(Point(200, 200)); // Èçìåíèòå êîîğäèíàòû ïğè íåîáõîäèìîñòè
               iceRink->Draw(); // Ïåğåğèñîâêà ôîğìû
           }
           System::Void buttonAddRedPlayer_Click(System::Object^ sender, System::EventArgs^ e) {
               iceRink->AddRedPlayer(Point(200, 200)); // Èçìåíèòå êîîğäèíàòû ïğè íåîáõîäèìîñòè
               iceRink->Draw(); // Ïåğåğèñîâêà ôîğìû
           }
           System::Void pictureBox1_DoubleClick(System::Object^ sender, System::EventArgs^ e) {
               List<GraphicElement^>^ elements = iceRink->getgraphicElements();
               for (int i = 0; i < elements->Count; i++)
               {
                   System::Drawing::Rectangle imageRect = System::Drawing::Rectangle(Point(elements[i]->coordinates.X, elements[i]->coordinates.Y), elements[i]->merge->Size);

                   if (imageRect.Contains(PointToClient(MousePosition)))
                   {
                       iceRink->deletePlayer(elements[i]->coordinates);
                   }
               }
               iceRink->Draw(); // Ïåğåğèñîâêà ôîğìû
           }
           //Ñîõğàíåíèå â XML
    private: System::Void SaveToXML_Click(System::Object^ sender, System::EventArgs^ e) {
        saveFileDialog1->Filter = "xml (*.xml)|*.xml|All files(*.*)|*.*";
        // Äèàëîãîâîå îêíî äëÿ ñîõğàíåíèÿ ôàéëà
        if (saveFileDialog1->ShowDialog() == System::Windows::Forms::DialogResult::OK) {
            // Ïîëó÷àåì ïóòü ê âûáğàííîìó ôàéëó
            String^ filePath = saveFileDialog1->FileName;

            // Ñîçäàåì îáúåêò IceRink (åñëè åãî åùå íåò)
            if (iceRink == nullptr) {
                iceRink = gcnew IceRink(pictureBox1);
            }
            // Âûçûâàåì ôóíêöèş ñîõğàíåíèÿ â XML
            iceRink->savexml();
            // Âûâîäèì ñîîáùåíèå îá óñïåøíîì ñîõğàíåíèè
            MessageBox::Show("Äàííûå óñïåøíî ñîõğàíåíû â XML ôàéë.", "Óñïåõ", MessageBoxButtons::OK, MessageBoxIcon::Information);
        }
    }
           //Çàãğóçêà èç XML
    private: System::Void LoadXML_Click(System::Object^ sender, System::EventArgs^ e) {
        pugi::xml_document doc;
        openFileDialog1->Filter = "xml (*.xml)|*.xml|All files(*.*)|*.*";
        if (openFileDialog1->ShowDialog() == System::Windows::Forms::DialogResult::OK) {
            iceRink->loadxml();
        }
    }
    private: System::Void delarrowToolStripMenuItem_Click(System::Object^ sender, System::EventArgs^ e) {
        if (iceRink->countArrows > 0) {
            iceRink->DeleteArrow();
            iceRink->Draw();
        }
    }
    private: System::Void buttonDrawArrow_Click(System::Object^ sender, System::EventArgs^ e) {
        // Äîáàâüòå ñòğåëêó ïğè íàæàòèè êíîïêè
        iceRink->AddArrow(gcnew Arrow(Point(100, 100), Point(150, 150)));
        iceRink->Draw();
    }
    private: System::Void pictureBox1_MouseUp(System::Object^ sender, System::Windows::Forms::MouseEventArgs^ e) {
        isDragging = false;
    }
    };
}



